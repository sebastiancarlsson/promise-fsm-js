/*!
 * PromiseFSM 0.1.1
 * Tue, 26 May 2015 09:53:03 GMT
 *
 * https://github.com/sebastiancarlsson/promise-fsm-js/
 *
 * (c) 2015 Sebastian Carlsson
 *
 * MIT license
 * https://github.com/sebastiancarlsson/promise-fsm-js/blob/master/LICENSE
 *
 **/
var PromiseFSM=function(){"use strict";function t(t,i){if(this.name=t,this.states=[],this.transitions=[],this.listeners=[],this.locked=!1,i.actions&&(this.actions=i.actions),i.states&&(this.states=i.states),this.verbose=i.verbose||!1,this["interface"]={$getState:this.getState.bind(this),$addTransition:this.addTransition.bind(this),$removeTransition:this.removeTransition.bind(this),$addEventListener:this.addEventlistener.bind(this),$removeEventListener:this.removeEventListener.bind(this)},this.verbose===!0&&e('Initializing state machine "'+this.name+'"'),!n)throw new Error("PromiseFSM - No promise adapter. Promise adapter must be set through PromiseFSM.setPromiseAdapter() before initialization");if(!(i.states&&"[object Array]"===Object.prototype.toString.call(this.states)&&i.states.length>1))throw new Error('PromiseFSM - You have to define at least two states. E.g. options.states = ["state1", "state2"]');if(this.states=i.states,!(i.actions&&"[object Object]"===Object.prototype.toString.call(this.actions)&&Object.keys(i.actions).length>0))throw new Error('PromiseFSM - You have to define at least one action. E.g. options.actions = { myAction: { from: "state1", to: "state2" } }');this.actions=i.actions;for(var s in this.actions)this["interface"][s]=this.transition.bind(this,this.actions[s].from,this.actions[s].to);this.initialState=this.state=i.initialState?i.initialState:this.states[0]}function e(t){console&&console.log("%cPromiseFSM","color: #00f",t)}function i(t){console&&console.warn("%cPromiseFSM","color: #00f",t)}function s(t,e,i){this.type=t,this.from=e,this.to=i}t.prototype.getState=function(){return this.state},t.prototype.transition=function(t,a){var h=n.defer();if(this.locked)return this.verbose&&i("State change failed - machine is locked"),h.reject(new Error(r.LOCKED)),h.promise;if(!this.isSwitchLegal(t,a))return this.verbose&&i('State change failed - illegal transition attempt from "'+t+'" to "'+a+'"'),h.reject(new Error(r.ILLEGAL_TRANSITION)),h.promise;this.locked=!0,this.dispatchEvent(new s(o.LOCKED,t,a)),this.dispatchEvent(new s(o.EXIT_STATE,t,a)),this.verbose&&e('"'+t+'" -> "'+a+'"');for(var c=[],l=this.transitions.length;l--;)this.transitions[l].from===t&&this.transitions[l].to===a&&c.push(this.transitions[l].callback);if(c.length>0){this.verbose&&e('Pending state change from "'+t+'" -> "'+a+'"...');var f,p=[];for(l=c.length;l--;)f=n.defer(),p.push(f.promise),c[l](f.resolve);var d=n.all(p);return d.then(this.completeSwitch.bind(this,a)),d}return this.completeSwitch(a),h.resolve(),h.promise},t.prototype.completeSwitch=function(t){var i=this.state;this.state=t,this.dispatchEvent(new s(o.ENTER_STATE,i,t)),this.locked=!1,this.dispatchEvent(new s(o.UNLOCKED,i,t)),this.dispatchEvent(new s(o.STATE_CHANGED,i,t)),this.verbose&&e('Transition completed. New state is "'+t+'".')},t.prototype.isSwitchLegal=function(t,e){if(t!==this.state)return!1;if(t===e)return!1;if(-1===this.states.indexOf(e))return console.log("doesnt exist"),!1;for(var i in this.actions)if(this.actions[i].to===e){if("string"==typeof this.actions[i].from&&(this.actions[i].from===t||"*"===this.actions[i].from))return!0;if("[object Array]"===Object.prototype.toString.call(this.actions[i].from))for(var s=this.actions[i].from,n=s.length;n--;)if(s[n]===t)return!0}return!1},t.prototype.addTransition=function(t,e,s){this.getTransitionIndex(t,e,s)>-1?i("Duplicate transition added, only the first will be called"):this.transitions.push({from:t,to:e,callback:s})},t.prototype.removeTransition=function(t,e,i){var s=this.getTransitionIndex(t,e,i);s>-1&&this.transitions.splice(s,1)},t.prototype.getTransitionIndex=function(t,e,i){for(var s=this.transitions.length;s--;)if(this.transitions[s].from===t&&this.transitions[s].to===e&&this.transitions[s].callback===i)return s;return-1},t.prototype.addEventlistener=function(t,e){this.listeners.push({type:t,callback:e})},t.prototype.removeEventListener=function(t,e){for(var i=this.listeners.length;i--;)this.listeners[i].type===t&&this.listeners[i].callback===e&&this.listeners.splice(i,1)},t.prototype.dispatchEvent=function(t){for(var e=this.listeners.length;e--;)this.listeners[e].type===t.type&&this.listeners[e].callback(t)},t.prototype.getInterface=function(){return this["interface"]};var n,o={LOCKED:"PromiseFSM/events/locked",EXIT_STATE:"PromiseFSM/events/exitState",ENTER_STATE:"PromiseFSM/events/enterState",UNLOCKED:"PromiseFSM/events/unlocked",STATE_CHANGED:"PromiseFSM/events/stateChanged"},r={ILLEGAL_TRANSITION:"ILLEGAL_TRANSITION",LOCKED:"LOCKED"},a={};return{EVENTS:o,ERRORS:r,setPromiseAdapter:function(t){n=t},create:function(e,i){return a[e]=new t(e,i),a[e].getInterface()},getMachine:function(t){var e=a[t];return e?e.getInterface():void 0}}}();"undefined"!=typeof module&&module.exports&&(module.exports=PromiseFSM);