/*!
 * PromiseFSM 0.1.3
 * Wed, 07 Oct 2015 11:18:13 GMT
 *
 * https://github.com/sebastiancarlsson/promise-fsm-js/
 *
 * (c) 2015 Sebastian Carlsson
 *
 * MIT license
 * https://github.com/sebastiancarlsson/promise-fsm-js/blob/master/LICENSE
 *
 **/
var PromiseFSM=function(){"use strict";function t(t,i){if(Object.defineProperty(this,"name",{value:t,writable:!1,enumerable:!0}),Object.defineProperty(this,"locked",{value:!1,writable:!0}),Object.defineProperty(this,"verbose",{value:i.verbose||!1,writable:!1}),Object.defineProperty(this,"transitions",{value:[],writable:!1}),Object.defineProperty(this,"listeners",{value:[],writable:!1}),this.verbose===!0&&e('Initializing state machine "'+this.name+'"'),!r)throw new Error("PromiseFSM - No promise adapter. Promise adapter must be set through PromiseFSM.setPromiseAdapter() before initialization");if(!(i.states&&"[object Array]"===Object.prototype.toString.call(i.states)&&i.states.length>1))throw new Error('PromiseFSM - You have to define at least two states. E.g. options.states = ["state1", "state2"]');if(Object.defineProperty(this,"states",{value:i.states,writable:!1}),!(i.actions&&"[object Object]"===Object.prototype.toString.call(i.actions)&&Object.keys(i.actions).length>0))throw new Error('PromiseFSM - You have to define at least one action. E.g. options.actions = { myAction: { from: "state1", to: "state2" } }');Object.defineProperty(this,"actions",{value:i.actions,writable:!1});for(var s in this.actions)this[s]=this.__transition.bind(this,this.actions[s].from,this.actions[s].to);Object.defineProperty(this,"state",{value:i.initialState||this.states[0],writable:!0})}function e(t){console&&console.log("%cPromiseFSM","color: #00f",t)}function i(t){console&&console.warn("%cPromiseFSM","color: #00f",t)}function s(t,e,i){this.type=t,this.from=e,this.to=i}Object.defineProperty(t.prototype,"__transition",{value:function(t,a){var c=r.defer();if(this.locked)return this.verbose&&i("State change failed - machine is locked"),c.reject(new Error(o.LOCKED)),c.promise;var h=!1;if(("[object Array]"===Object.prototype.toString.call(t)&&t.indexOf(this.state)>-1||t===this.state)&&(h=!0),!h)return this.verbose&&i('State change failed - illegal transition attempt from "'+this.state+'" to "'+a+'"'),c.reject(new Error(o.ILLEGAL_TRANSITION)),c.promise;this.locked=!0,this.__dispatchEvent(new s(n.LOCKED,this.state,a)),this.__dispatchEvent(new s(n.EXIT_STATE,this.state,a)),this.verbose&&e('"'+this.state+'" -> "'+a+'"');for(var l=[],p=this.transitions.length;p--;)this.transitions[p].from===this.state&&this.transitions[p].to===a&&l.push(this.transitions[p].callback);var f=Array.prototype.slice.call(arguments).splice(2);if(l.length>0){this.verbose&&e('Pending state change from "'+this.state+'" -> "'+a+'"...');var v,u,d=[];for(p=l.length;p--;)v=r.defer(),d.push(v.promise),u=f.slice(),u.unshift(v.resolve),l[p].apply(null,u);var b=r.all(d);return b.then(this.__completeSwitch.bind(this,a)),b}return this.__completeSwitch(a),c.resolve(),c.promise}}),Object.defineProperty(t.prototype,"__completeSwitch",{value:function(t){var i=this.state;this.state=t,this.__dispatchEvent(new s(n.ENTER_STATE,i,t)),this.locked=!1,this.__dispatchEvent(new s(n.UNLOCKED,i,t)),this.__dispatchEvent(new s(n.STATE_CHANGED,i,t)),this.verbose&&e('Transition completed. New state is "'+t+'".')}}),Object.defineProperty(t.prototype,"__getTransitionIndex",{value:function(t,e,i){for(var s=this.transitions.length;s--;)if(this.transitions[s].from===t&&this.transitions[s].to===e&&this.transitions[s].callback===i)return s;return-1}}),Object.defineProperty(t.prototype,"__dispatchEvent",{value:function(t){for(var e=this.listeners.length;e--;)this.listeners[e].type===t.type&&this.listeners[e].callback(t)}}),t.prototype.$getState=function(){return this.state},t.prototype.$addTransition=function(t,e,s){this.__getTransitionIndex(t,e,s)>-1?i("Duplicate transition added, only the first will be called"):this.transitions.push({from:t,to:e,callback:s})},t.prototype.$removeTransition=function(t,e,i){var s=this.__getTransitionIndex(t,e,i);s>-1&&this.transitions.splice(s,1)},t.prototype.$addEventListener=function(t,e){this.listeners.push({type:t,callback:e})},t.prototype.$removeEventListener=function(t,e){for(var i=this.listeners.length;i--;)this.listeners[i].type===t&&this.listeners[i].callback===e&&this.listeners.splice(i,1)};var r,n={LOCKED:"PromiseFSM/events/locked",EXIT_STATE:"PromiseFSM/events/exitState",ENTER_STATE:"PromiseFSM/events/enterState",UNLOCKED:"PromiseFSM/events/unlocked",STATE_CHANGED:"PromiseFSM/events/stateChanged"},o={ILLEGAL_TRANSITION:"ILLEGAL_TRANSITION",LOCKED:"LOCKED"},a={};return{EVENTS:n,ERRORS:o,setPromiseAdapter:function(t){r=t},create:function(e,i){return a[e]=new t(e,i),a[e]},getMachine:function(t){var e=a[t];return e?e:void 0}}}();